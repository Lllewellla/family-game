# Инструкция по деплою FamilyQuest

## Шаг 1: Подготовка репозитория

1. Создайте новый репозиторий на GitHub
2. Склонируйте его локально
3. Скопируйте все файлы проекта в репозиторий
4. Закоммитьте и запушьте изменения

## Шаг 2: Настройка Backend (Railway)

### 2.1 Создание проекта на Railway

1. Зайдите на [Railway](https://railway.app)
2. Создайте новый проект
3. Подключите ваш GitHub репозиторий
4. Выберите папку `backend` как корневую директорию

### 2.2 Добавление PostgreSQL

1. В Railway проекте нажмите "New" → "Database" → "Add PostgreSQL"
2. Railway автоматически создаст базу данных и добавит переменную `DATABASE_URL`

### 2.3 Настройка переменных окружения

В настройках проекта добавьте следующие переменные. **Подробный список с инструкциями см. в файле `RAILWAY_VARIABLES.md`**

**Обязательные переменные:**
- `TELEGRAM_BOT_TOKEN` - токен от BotFather
- `DATABASE_URL` - автоматически создается Railway при добавлении PostgreSQL
- `GITHUB_ACCESS_TOKEN` - GitHub Personal Access Token
- `GITHUB_REPO` - репозиторий для дневника (формат: `username/repo`)
- `MINI_APP_URL` - URL GitHub Pages фронтенда
- `BACKEND_URL` - URL вашего Railway приложения

**Опциональные:**
- `OPENROUTER_API_KEY` - для AI-обработки заметок
- `ADMIN_IDS` - Telegram ID администраторов (через запятую)

### 2.4 Получение Telegram Bot Token

1. Откройте [@BotFather](https://t.me/botfather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в переменную `TELEGRAM_BOT_TOKEN`

### 2.5 Получение GitHub Token

1. Зайдите в GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Создайте новый токен с правами `repo`
3. Скопируйте токен в переменную `GITHUB_ACCESS_TOKEN`

### 2.6 Создание репозитория для дневника

1. Создайте новый приватный репозиторий на GitHub (например, `baby-diary`)
2. Укажите его в формате `username/repo` в переменной `GITHUB_REPO`

### 2.7 Деплой

Railway автоматически определит Python проект и запустит его. Проверьте логи в Railway Dashboard.

## Шаг 3: Настройка Frontend (GitHub Pages)

### 3.1 Подготовка файлов

1. Скопируйте содержимое папки `frontend` в папку `docs/` в корне репозитория:

```bash
cp -r frontend/* docs/
```

2. Обновите `docs/config.js` с URL вашего Railway приложения:

```javascript
window.BACKEND_URL = 'https://your-app.railway.app';
```

3. Закоммитьте и запушьте изменения

### 3.2 Настройка GitHub Pages

1. Зайдите в Settings вашего репозитория
2. Перейдите в раздел "Pages"
3. В "Source" выберите "Deploy from a branch"
4. Выберите ветку `main` и папку `/docs`
5. Сохраните изменения
6. GitHub автоматически опубликует сайт по адресу: `https://your-username.github.io/repo-name/`

### 3.3 Обновление MINI_APP_URL

Обновите переменную `MINI_APP_URL` в Railway с адресом вашего GitHub Pages сайта.

## Шаг 4: Настройка Telegram Bot

### 4.1 Настройка Menu Button

1. Откройте [@BotFather](https://t.me/botfather)
2. Отправьте команду `/mybots`
3. Выберите вашего бота
4. Выберите "Bot Settings" → "Menu Button"
5. Выберите "Configure Menu Button"
6. Введите текст кнопки: "Открыть Трекер"
7. Введите URL вашего GitHub Pages сайта

### 4.2 Тестирование

1. Откройте вашего бота в Telegram
2. Нажмите команду `/start`
3. Нажмите кнопку "Открыть Трекер" или Menu Button
4. Приложение должно открыться в Telegram

## Шаг 5: Проверка работоспособности

### Чек-лист:

- [ ] Backend запущен на Railway (проверьте логи)
- [ ] База данных подключена (проверьте переменную DATABASE_URL)
- [ ] Frontend доступен на GitHub Pages
- [ ] Telegram бот отвечает на команду `/start`
- [ ] Menu Button открывает приложение
- [ ] Приложение загружается и показывает интерфейс
- [ ] Можно создать привычку
- [ ] Можно отметить выполнение привычки
- [ ] XP начисляется корректно
- [ ] Можно добавить событие в дневник малыша
- [ ] Экспорт дневника работает

## Устранение неполадок

### Backend не запускается

- Проверьте логи в Railway Dashboard
- Убедитесь, что все переменные окружения установлены
- Проверьте, что `DATABASE_URL` корректный

### Frontend не загружается

- Проверьте, что файлы находятся в папке `docs/`
- Убедитесь, что GitHub Pages включен
- Проверьте консоль браузера на ошибки
- Убедитесь, что `BACKEND_URL` в `config.js` указан правильно

### Telegram бот не работает

- Проверьте, что `TELEGRAM_BOT_TOKEN` правильный
- Убедитесь, что бот запущен (Railway должен показывать активный процесс)
- Проверьте логи бота в Railway

### Ошибки CORS

- Убедитесь, что в `backend/app/main.py` CORS настроен правильно
- Проверьте, что `BACKEND_URL` в фронтенде совпадает с URL Railway

## Дополнительные настройки

### Настройка домена (опционально)

1. В Railway можно настроить кастомный домен
2. Обновите `MINI_APP_URL` и `BACKEND_URL` соответственно

### Мониторинг

- Railway предоставляет базовый мониторинг в Dashboard
- Можно настроить алерты для критических ошибок

## Поддержка

При возникновении проблем проверьте:
1. Логи в Railway Dashboard
2. Консоль браузера (F12)
3. Логи Telegram бота
4. Статус GitHub Pages в настройках репозитория
